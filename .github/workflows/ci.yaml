name: Tests

on:
  # Run on PRs and pushes, only on significant changes.
  push:
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'

env:
  # The hostname used to communicate with the PostgreSQL service container
  POSTGRES_HOST: postgres
  # The default PostgreSQL port
  POSTGRES_PORT: 5432

jobs:
    tests:
        name: Tests on PHP ${{ matrix.php }}
        runs-on: ubuntu-latestg
        strategy:
            fail-fast: false
            matrix:
                php: [ 7.4 ]
        services:
          postgres:
            # Docker Hub image
            image: postgres
            # Provide the password for postgres
            env:
              POSTGRES_PASSWORD: postgres
            # Set health checks to wait until postgres has started
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5

        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                php-version: ${{ matrix.php }}

            - name: Install Composer dependencies
              uses: "ramsey/composer-install@v1"

            - name: Run migrations
              run: php bin/console doctrine:migrations:migrate

            - name: Run tests
              run: make tests
